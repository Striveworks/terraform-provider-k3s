---
# generated by https://github.com/hashicorp/terraform-plugin-docs

page_title: "k3s_server Resource - k3s"
subcategory: ""
description: |-
  Creates a k3s server resource. Only one of password or private_key can be passed.
  If ran in highly available mode, it is up to the consumers of this module to correctly implement the raft protocol and create an odd number of ha nodes. Due to how HA works, we do not offer a method to gracefully delete a controller node from the cluster before running k3s-uninstall.sh during deletion of this resource.
---

# k3s_server (Resource)

Creates a k3s server resource. Only one of `password` or `private_key` can be passed.
If ran in highly available mode, it is up to the consumers of this module to correctly implement the raft protocol and create an odd number of ha nodes. Due to how HA works, we do not offer a method to gracefully delete a controller node from the cluster before running `k3s-uninstall.sh` during deletion of this resource.

 
## Example Usage



### Single node

Example on running a simple single node k3s cluster.
 

```terraform
variable "host" {
  type = string
}

variable "user" {
  type = string
}

variable "private_key" {
  type      = string
  sensitive = true
}

variable "config" {
  type    = string
  default = null
}

resource "k3s_server" "main" {
  auth = {
    host        = var.host
    user        = var.user
    private_key = var.private_key
  }
  config = var.config
}
``` 


### High availability nodes

Example on running a k3s in HA mode with embedded etcd.
 

```terraform
variable "hosts" {
  type    = list(string)
  default = []

  validation {
    condition     = length(var.hosts) > 1 && length(var.hosts) % 2 != 0
    error_message = "Ensure more than 3 and odd nodes"
  }
}

variable "user" {
  type = string
}

variable "private_key" {
  type      = string
  sensitive = true
}

variable "config" {
  type    = string
  default = null
}

resource "k3s_server" "init" {
  auth = {
    host        = var.hosts[0]
    user        = var.user
    private_key = var.private_key
  }
  config = var.config
  highly_available = {
    cluster_init = true
  }
}

resource "k3s_server" "join" {
  count = length(var.hosts) - 1

  auth = {
    host        = var.hosts[count.index + 1]
    user        = var.user
    private_key = var.private_key
  }
  config = var.config
  highly_available = {
    token  = k3s_server.init.token
    server = k3s_server.init.server
  }
}
``` 


### Launch With OIDC Support

Many possibilties

- You can eithe auth to the cluster with keycloak like [this](https://geek-cookbook.funkypenguin.co.nz/kubernetes/oidc-authentication/k3s-keycloak/).

- Employ IRSA in your cluster with [eks-pod-identity](https://github.com/aws/amazon-eks-pod-identity-webhook)
 

```terraform
variable "host" {
  type = string
}

variable "user" {
  type = string
}

variable "private_key" {
  type      = string
  sensitive = true
}

variable "config" {
  type    = string
  default = null
}

variable "oidc_config" {
  type = object({
    audience    = string
    pkcs8       = string
    signing_key = string
    issuer      = string
  })
  sensitive = true
}

resource "k3s_server" "init" {
  auth = {
    host        = var.host
    user        = var.user
    private_key = var.private_key
  }
  config      = var.config
  oidc_config = var.oidc_config
}

output "jwks" {
  value     = k3s_server.init.oidc_config.jwks
  sensitive = true
}
``` 


<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `auth` (Attributes) Auth configuration for the node (see [below for nested schema](#nestedatt--auth))

### Optional

- `bin_dir` (String) Value of a path used to put the k3s binary
- `config` (String) K3s server config
- `highly_available` (Attributes) Run server node in highly available mode (see [below for nested schema](#nestedatt--highly_available))
- `oidc` (Attributes) Support for including oidc provider in k3s (see [below for nested schema](#nestedatt--oidc))
- `registry` (String) K3s server registry

### Read-Only

- `active` (Boolean) The health of the server
- `cluster_auth` (Attributes) Cluster auth objects (see [below for nested schema](#nestedatt--cluster_auth))
- `id` (String) Id of the k3s server resource
- `kubeconfig` (String, Sensitive) KubeConfig for the cluster
- `server` (String) Server url  used for joining nodes to the cluster.
- `token` (String, Sensitive) Server token used for joining nodes to the cluster

<a id="nestedatt--auth"></a>
### Nested Schema for `auth`

Optional:

- `host` (String) Hostname of the target server
- `password` (String, Sensitive) Username of the target server
- `port` (Number) Override default SSH port (22)
- `private_key` (String, Sensitive) Private ssh key value to be used in place of a password
- `user` (String) Username of the target server


<a id="nestedatt--highly_available"></a>
### Nested Schema for `highly_available`

Optional:

- `cluster_init` (Boolean) Node is the init node for the HA cluster
- `server` (String) Url of init node
- `token` (String, Sensitive) Server token used for joining nodes to the cluster


<a id="nestedatt--oidc"></a>
### Nested Schema for `oidc`

Required:

- `audience` (String, Sensitive) OIDC Audience
- `issuer` (String, Sensitive) Issuer url
- `pkcs8` (String, Sensitive) Public signing key
- `signing_key` (String, Sensitive) Private signing key

Read-Only:

- `jwks_keys` (String, Sensitive) JSON web key set generated by the cluster following API server configuration


<a id="nestedatt--cluster_auth"></a>
### Nested Schema for `cluster_auth`

Read-Only:

- `certificate_authority_data` (String, Sensitive) Client CA, already base64 decoded
- `client_certificate_data` (String, Sensitive) Client user certificate, already base64 decoded
- `client_key_data` (String, Sensitive) Client user key, already base64 decoded
- `server` (String) Apiserver address